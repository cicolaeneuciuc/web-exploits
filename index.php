<?php
	session_start();
	include('db.php');
	include("functions.php");
	include("Vulnerabilities.php");
	if (!isset($_GET["p"])) {
		$page = 0;
	} else {
		$page = $_GET["p"] - 1;
	}

	if (!isset($_GET["keyword"])) {
		$keyword = "";
	} else {
		$keyword = $_GET["keyword"];
	}

	if (!isset($_GET["filters"])) {
		$filters = array();
	} else {
		if (count($_GET["filters"]) == 0 || !isJson($_GET["filters"])) {
			$filters = array();
		}else{
			$filters=json_decode($_GET["filters"],true);
		}
	}
?>
<!DOCTYPE HTML>
<html class="" lang="en-US">
<head>
	<meta charset="UTF-8">

	<title>Vulnerabilities App Alert</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/css.css">

	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
</head>
<body>
<div class="static_nav">
	<img src="assets/img/3.png" class="icon_mobile" onclick="open_menu()">
	<p class="text_l"><span style="">Security</span> API</p>
	<a href="index.php"><p class="home_but">Home</p></a>
	<a href="#" id="modal-history-btn"><p class="home_but">History</p></a>
	<a href="#" id="modal-how-to-use-btn"><p class="home_but">How to use</p></a>
	<a href="#" id="modal-aboneaza-te-btn"><p class="home_but">Subscribe</p></a>
	<a href="api.json.php"><img src="assets/img/1.png" class="icon_right"></a>
	<a href="api.rss.php"><img src="assets/img/2.png" class="icon_right"></a>
	<form action='index.php' method="GET"
		  style="display: inline-block; float: right; margin-right: 50px; margin-top:5px">
		<input type="hidden" value='<?php echo json_encode($filters);?>' name="filters">
		<input placeholder="Keyword..." required type="text" name="keyword"
			   value="<?php echo $keyword; ?>" class="input">
		<input type="submit" value="Search" class="buton">
	</form>
</div>
<div class="left" id="left">
	<br>

	<p class="text_l" style="    text-align: center;
    width: 100%; margin-left: 0px">Categorii</p>
	<hr>

	<label class="switch ">
		<input type="checkbox" name="filters[]" value="webapps" class="check" id="c1" onclick="thisFunc()" <?php if(!in_array("webapps",$filters)){ echo"checked"; } ?>>
		<span class="slider round"></span>
	</label>
	<p class="buton_open">WebApps</p><br>

	<label class="switch round">
		<input type="checkbox" name="filters[]" value="remote" class="check" id="c2" onclick="thisFunc()"  <?php if(!in_array("remote",$filters)){  echo"checked"; } ?>>
		<span class="slider round"></span>
	</label>
	<p class="buton_open">Remote</p><br>
	<label class="switch round">
		<input type="checkbox" name="filters[]" value="local" class="check" id="c3" onclick="thisFunc()" <?php if(!in_array("local",$filters)){  echo"checked"; } ?>>
		<span class="slider round"></span>
	</label>

	<p class="buton_open">Local</p><br>
	<label class="switch round">
		<input type="checkbox" name="filters[]" value="dos" class="check" id="c4" onclick="thisFunc()"  <?php if(!in_array("dos",$filters)){  echo"checked"; } ?>>
		<span class="slider round"></span>
	</label>
	<p class="buton_open">DOS</p><br>
	<hr>
	<a href="api.json.php"><img src="assets/img/1.png" class="icon_right2"></a>
	<a href="api.rss.php"><img src="assets/img/2.png" class="icon_right2"></a><br>
	<a href="index.php"><p class="home_but2">Home</p></a>
	<a href="#" id="modal-history-btn-1"><p class="home_but2">History</p></a>
	<a href="#" id="modal-how-to-use-btn-1"><p class="home_but2">How to use</p></a>
	<a href="#" id="modal-aboneaza-te-btn-1"><p class="home_but2">Subscribe</p></a>
	<form action='index.php' method="GET" style="display:block;margin-top:5px">
		<input type="hidden" value='<?php echo json_encode($filters);?>' name="filters">
		<input placeholder="Keyword..." required type="text" name="keyword"
			   value="<?php echo $keyword; ?>" class="input2">
		<input type="submit" value="Search" class="buton2">
	</form>

</div>
<div class="right">

	<?php


		$result = getVulnerabilities($conn, $keyword, $filters, $page);
		$stmt=$result["results"];
		$nr_results = $result["nr_results"];
		if (isset($_SESSION["eroare"])){
	?>

	<div class="show_this">
		<div class="alert">
			<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
			<center><strong>Alert!</strong> <?php if (isset($_SESSION["eroare"])) {
					echo $_SESSION["eroare"];
					unset($_SESSION["eroare"]);
				} ?></center>
		</div>
		<?php
			}


			if (isset($_SESSION["mesaj"])){
		?>

		<div class="show_this">
			<div class="success">
				<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
				<center><strong>Success!</strong> <?php if (isset($_SESSION["mesaj"])) {
						echo $_SESSION["mesaj"];
						unset($_SESSION["mesaj"]);
					} ?></center>
			</div>
			<?php
				}
			?>
			<center><h1><?php echo "Vulnerabilities"; ?></h1></center>


			<br>
			<?php
				if($nr_results>0){
					if(isset($_GET["keyword"])){
						echo"<h3 style='color: white; text-align: center;'>Here is what we found:</h3>";
					}
			?>
			<table align="center">
				<thead>
				<tr>
                    <th>New</th>
					<th>Date</th>
					<th>Title</th>
					<th>Raw</th>
					<th>Author</th>
					<th>Category</th>
				</tr>
				</thead>
				<tbody>
				<?php $i = 0;
					foreach ($stmt as $row) { ?>
						<tr class="row-category-<?php echo $row["category"]; ?>">
                            <td>
                                <?php
                                    if($row["new"]=="1"){
                                        echo"<img src='assets/img/new.gif' style='width: 30px; height: auto;'>";
                                    }

                                ?>
                            </td>
							<td>
								<?php echo $row["date"]; ?>
							</td>
							<td>
								<a href="<?php echo $row["link"]; ?>"> <?php echo $row["titlu"]; ?></a>
							</td>
							<td>
								<a href="<?php echo $row["raw"]; ?>">View Content</a>
							</td>
							<td>
								<?php echo $row["autor"]; ?>
							</td>
							<td><?php echo $row["category"]; ?></td>
						</tr>
					<?php } ?>
				</tbody>
			</table>
			<?php }else{
					echo"<h3 style='color: white; text-align: center;'>No entries found!</h3>";
				} ?>
		</div>
		<div style="text-align: center;">


			<?php

				for ($i = 0; $i <= $nr_results / 30; $i++) {
					if (isset($_GET["keyword"])) {
						?>
						<a <?php if ($i == $page) { ?> style="color: white" <?php } ?>
							href='index.php?p=<?php echo $i + 1; ?>&keyword=<?php echo $keyword; ?>&filters=<?php echo json_encode($filters);?>'><?php echo $i + 1; ?>
						</a>&nbsp; &nbsp;
						<?php
					} else {
						?>
						<a href='index.php?p=<?php echo $i + 1; ?>&filters=<?php echo json_encode($filters);?>' <?php if ($i == $page) { ?> style="color: white" <?php } ?>><?php echo $i + 1; ?> </a>&nbsp; &nbsp;
						<?php
					}

				}
			?>
		</div>
		<br>
	</div>


	<!-- The Modal -->
	<div id="modal-history" class="modal">

		<!-- Modal content -->
		<div class="modal-content">
			<span class="close">&times;</span>
			<h2 style="color: #d54f33">History</h2>
			<hr>
			<?php include("history.php"); ?>
		</div>

	</div>


	<!-- The Modal -->
	<div id="modal-how-to-use" class="modal">

		<!-- Modal content -->
		<div class="modal-content">
			<span class="close">&times;</span>
			<h2 style="color: #d54f33">How to use</h2>
			<hr>
			<?php include("how-to-use.php"); ?>
		</div>

	</div>


	<div id="modal-aboneaza-te" class="modal">

		<!-- Modal content -->
		<div class="modal-content">
			<span class="close">&times;</span>
			<h2 style="color: #d54f33">Subscribe</h2>
			<hr>
			<form action="subscribe.php" method="POST" style="display:block">
				<input placeholder="Your Email..." required type="email" name="email" class="input input_full">
				<br>
				<h3>Choose what category interests you to receive email when a new exploit is found</h3>
				<hr>
				<label class="switch ">
					<input type="checkbox" name="category[]" value="webapps" checked>
					<span class="slider round"></span>
				</label>
				<p class="buton_open">WebApps</p><br>

				<label class="switch round">
					<input type="checkbox" name="category[]" value="remote" checked>
					<span class="slider round"></span>
				</label>
				<p class="buton_open">Remote</p><br>

				<label class="switch round">
					<input type="checkbox" name="category[]" value="local" checked>
					<span class="slider round"></span>
				</label>
				<p class="buton_open">Local</p><br>

				<label class="switch round">
					<input type="checkbox" name="category[]" value="dos" checked>
					<span class="slider round"></span>
				</label>
				<p class="buton_open">DOS</p><br>

				<input type="submit" value="Subscribe" class="buton center_but">
			</form>
			<hr>
			<h3>Enter email to unsubscribe</h3>
			<form action="unsubscribe.php" method="post">
				<input placeholder="Your Email..." required type="email" name="email" class="input input_full">
				<br>
				<br>
				<input type="submit" value="Unsubscribe" class="buton center_but">
			</form>
		</div>

	</div>
	<script src="assets/js/script.js"></script>
	<script src="assets/js/modal.js"></script>
</body>
</html>
