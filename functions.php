<?php
	require_once 'PHPMailer/src/Exception.php';
	require_once 'PHPMailer/src/PHPMailer.php';
	require_once 'PHPMailer/src/SMTP.php';

	use PHPMailer\PHPMailer\Exception;
	use PHPMailer\PHPMailer\PHPMailer;

	function getContent($url){
		$user_agent = 'Mozilla/5.0 (Windows NT 6.1; rv:8.0) Gecko/20100101 Firefox/8.0';

		$options = array(

			CURLOPT_CUSTOMREQUEST => "GET",        //set request type post or get
			CURLOPT_POST => false,        //set to GET
			CURLOPT_USERAGENT => $user_agent, //set user agent
			CURLOPT_COOKIEFILE => "cookie.txt", //set cookie file
			CURLOPT_COOKIEJAR => "cookie.txt", //set cookie jar
			CURLOPT_RETURNTRANSFER => true,     // return web page
			CURLOPT_HEADER => false,    // don't return headers
			CURLOPT_FOLLOWLOCATION => true,     // follow redirects
			CURLOPT_ENCODING => "",       // handle all encodings
			CURLOPT_AUTOREFERER => true,     // set referer on redirect
			CURLOPT_CONNECTTIMEOUT => 120,      // timeout on connect
			CURLOPT_TIMEOUT => 120,      // timeout on response
			CURLOPT_MAXREDIRS => 10,       // stop after 10 redirects
		);

		$ch = curl_init($url);
		curl_setopt_array($ch, $options);
		$content = curl_exec($ch);
		$err = curl_errno($ch);
		$errmsg = curl_error($ch);
		$header = curl_getinfo($ch);
		curl_close($ch);
		return $content;
	}

	function isJson($string)
	{
		json_decode($string);
		return (json_last_error() == JSON_ERROR_NONE);
	}

	$categories = ["webapps", "remote", "local", "dos"];//Vectorul unde tin categoriile de vulnerabilitati
	function send_notifications_emails($conn, $categories_found)
	{
		//PHPMailer Object
		$mail = new PHPMailer;
//Tell PHPMailer to use SMTP
		$mail->isSMTP();
//Enable SMTP debugging
// 0 = off (for production use)
// 1 = client messages
// 2 = client and server messages
		$mail->SMTPDebug = 0;
//Set the hostname of the mail server
		$mail->Host = 'smtp.gmail.com';
// use
// $mail->Host = gethostbyname('smtp.gmail.com');
// if your network does not support SMTP over IPv6
//Set the SMTP port number - 587 for authenticated TLS, a.k.a. RFC4409 SMTP submission
		$mail->Port = 587;
//Set the encryption system to use - ssl (deprecated) or tls
		$mail->SMTPSecure = 'tls';
//Whether to use SMTP authentication
		$mail->SMTPAuth = true;
//Username to use for SMTP authentication - use full email address for gmail
		$mail->Username = "noreplylivemenu@gmail.com";
//Password to use for SMTP authentication
		$mail->Password = "Vica21061999";

//From email address and name
		$mail->From = "reminderexploits@gmail.com";
		$mail->FromName = "Reminder Exploits";

		$result = $conn->query("SELECT *FROM emails");
		while ($row = $result->fetch()) {
			//To address and name
			foreach ($categories_found as $key => $category) {
				if (($category > 0 && in_array($key, json_decode($row["categories"], true))) || trim($row["categories"]) == "") {
					$mail->addAddress($row["email"]);
					break;
				}
			}

		}


//Send HTML or Plain Text email
		$mail->isHTML(true);

		$mail->Subject = "New Exploit on website!";
		$mail->Body = "There is a new exploit on website <a href='https://dev.d-soft.ro/security-api/'>click</a> here to access it!";


		if (!$mail->send()) {
			echo "Mailer Error: " . $mail->ErrorInfo;
		} else {
			//echo "Message has been sent successfully";
		}


	}

?>